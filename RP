#!/usr/bin/env python
# coding: utf-8
# RP, a micro Radio Paradise Player
# Relies on mplayer + libnotify for OSD
#
# You can use mplayer bindings to control play. By default:
# - q to exit
# - / and * for vol- and vol +
# - see mplayer man pages for others
#
# Author: Anisse Astier <anisse@astier.eu>


import pynotify
import urllib2
import tempfile
import subprocess
import os
import cgi

def show_current(text, subtext, imgurl):
    try:
        img = urllib2.urlopen(imgurl).read()
        tmpfile = tempfile.NamedTemporaryFile(suffix='.jpg', delete=False)
        tmpfile.write(img)
        tmpfile.close()
        imgfilepath = tmpfile.name
    except: #whatever happened(URL, fetching, tempfile creationâ€¦), we just don't have any image to show
        imgfilepath = None

    # libnotify "Summary" is allowed to contain HTML markup. Escape HTML chars.
    subtext = cgi.escape(subtext)
    notif = pynotify.Notification(text, subtext, imgfilepath)
    notif.set_timeout(3500)
    notif.show()
    #notif.close()
    if imgfilepath != None and tmpfile != None:
        os.unlink(tmpfile.name)


def player(playlisturl):
    files = urllib2.urlopen(playlisturl).read() #TODO: check for errors
    playlist = files.split('\n')
    cmd = ['mplayer', '-vo', 'null', '-quiet'] + playlist
    p = subprocess.Popen(cmd, stdout=subprocess.PIPE, stderr=subprocess.PIPE) #TODO: check for errors
    while p.poll() == None:
        l = p.stdout.readline()
        #parsing sample:
        # ICY Info: StreamTitle='Jimi Hendrix - The Wind Cries Mary';StreamUrl='http://www.radioparadise.com/graphics/covers/m/B000002OOG.jpg';
        if l.find("ICY Info: StreamTitle=") == -1:
            continue
        l = l[len('ICY Info: '):] #remove prefix
        coverurl = artist = songname = ""
        for tok in l.split(';'):
            if len(tok) < 10:
                continue
            (tokname,tokvalue) = tok.split('=', 1)
            if tokname == "StreamTitle":
                song = tokvalue.strip("'")
                artist,songname = song.split(" - ", 1)
            elif tokname == "StreamUrl":
                coverurl = tokvalue.strip("'")
        print "%s - %s"%(artist,songname)
        show_current(artist, songname, coverurl)
    #p.kill()


#TODO:
# - properly exit on SIGSTOP, killing mplayer, removing tempfile
# - re-use notify object
# - keep playlist and images in a cache
# - use gstreamer instead of mplayer


def main():
    player ("http://www.radioparadise.com/musiclinks/rp_128aac.m3u")

if __name__ == '__main__':
    main()
